/*!
 * quickhybrid v0.0.1
 * (c) 2017-2017 dailc
 * Released under the BSD-3-Clause License.
 * https://github.com/quickhybrid/quickhybrid
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.quick=n()}(this,function(){"use strict";function e(e){console.error("[hybridJs error]: "+e)}function n(e){console.log("[hybridJs log]: "+e)}function r(n){function r(e,n){var r=u+"://"+e,o=void 0,t=void 0,i=void 0;return n.callbackId&&(o=n.callbackId,t=n.handlerName,i=n.data),i=encodeURIComponent(function(e){return"string"!=typeof e?JSON.stringify(e):e}(i)),r+=":"+o+"/"+t+"?"+i}function o(n,o,t){var i=o;if("function"==typeof t){var a=Math.floor(Math.random()*R);l[a]=t,i.callbackId=a}else i.callbackId=t;var s=r(n,i);c.quick?c.ios?window.webkit.messageHandlers.WKWebViewJavascriptBridge.postMessage(s):window.top.prompt(s,""):e("浏览器中jsbridge无效,对应scheme:"+s)}var t=n;window.JSBridge={};var i=window.JSBridge,a=t.showError,s=t.globalError,c=t.os;t.JSBridge=i;var u="QuickHybridJSBridge",d={},l={},f={},R=2147483647;i.registerHandler=function(e,n){d[e]=n},i.registerLongCallback=function(e,n){f[e]=n},i.getLongCallbackId=function(){return R-=1},i.callHandler=function(e,n,r,t){o(e,{handlerName:n,data:r},t)},i._handleMessageFromNative=function(e){setTimeout(function(){var n=void 0;try{"string"==typeof e?(n=decodeURIComponent(e),n=JSON.parse(n)):n=e}catch(e){return void a(s.ERROR_TYPE_NATIVECALL.code,s.ERROR_TYPE_NATIVECALL.msg)}var r=n.responseId,o=n.responseData,t=void 0;if(r)(t=(t=l[r])||f[r])&&t(o),delete l[r];else{var i=d[n.handlerName],c=n.data;i&&i(c)}})}}function o(e){var n=Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1];return"String"!==n&&"Number"!==n&&"Boolean"!==n&&"Undefined"!==n&&"Null"!==n}function t(e){for(var n=e,r=arguments.length,o=Array(r>1?r-1:0),t=1;t<r;t++)o[t-1]=arguments[t];return o.forEach(function(e){Object.keys(e).forEach(function(r){n[r]=e[r]})}),n}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6,r=0;return e.split("").filter(function(e){return(r+=/[\u4e00-\u9fa5]/.test(e)?2:1)<=n}).join("")}function a(e){if(/^(http|https|ftp|\/\/)/g.test(e))return e;return/(\.\/)|(\.\.\/)/.test(e)?function(e){var n=window.location,r=n.pathname,o=e.match(/\.\.\//g),t=o&&o.length||0,i=r.split("/"),a=i.slice(0,i.length-(t+1)).join("/")+"/"+e.replace(/\.+\//g,"");return a=n.protocol+"//"+n.host+a}(e):""+function(){var e=window.location,n=e.pathname.split("/"),r=n.length>2,o=n[Number(r)]+"/";return(e.protocol+"//"+e.host+"/"+o).replace(/[/]{2}$/,"/")}()+e}function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments[1],r=a(e),o="";return n&&Object.keys(n).forEach(function(e){-1===o.indexOf("?")&&-1===r.indexOf("?")?o+="?":o+="&",o+=e+"="+n[e]}),r+=o}function c(e){return function(n,r,o){var t=n.success,i=n.error,a=n.dataFilter,s=n.proto,c=n.handlerName,u=n.isLongCb,d=n.isEvent,l=n.data,f=function(e){if(0===e.code)i&&i(e),!u&&o&&o(e);else{var n=e;a&&(n=a(n)),t&&t(n.result),!u&&r&&r(n.result)}};if(u){var R=e.getLongCallbackId();d&&(l.port=R),e.registerLongCallback(R,f),e.callHandler(s,c,l,R),r&&r()}else e.callHandler(s,c,l,f)}}function u(e){function n(e,n,r,o){Object.defineProperty(e,n,{configurable:!0,enumerable:!0,get:function(){var e=d[r],n=e[function(e){for(var n=0,r=R.length;n<r;n+=1)if(e[R[n]])return R[n];return"h5"}(c)]||e.h5;if(n)return n.walk();var t=o.os?o.os.join("或"):'"非法"',i=o.namespace+"要求的os环境为:"+t;return s(a.ERROR_TYPE_APIOS.code,i),f},set:function(){s(a.ERROR_TYPE_APIMODIFY.code,a.ERROR_TYPE_APIMODIFY.msg)}})}function r(e){Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get:function(){return l[e]||(l[e]={}),l[e]},set:function(){s(a.ERROR_TYPE_MODULEMODIFY.code,a.ERROR_TYPE_MODULEMODIFY.msg)}})}function o(e,o){if(o&&o.namespace){t[e]||r(e);var a=o,s=t[e],c=a.namespace;a.moduleName=e;var l=function(e,n){var r=e;return(/[.]/.test(n)?n.replace(/[.][^.]+$/,"").split("."):[]).forEach(function(e){r[e]=r[e]||{},r=r[e]}),r}(s,c),f=e+"."+a.namespace,E=/[.]/.test(c)?a.namespace.match(/[.][^.]+$/)[0].substr(1):c;d[f]||n(l,E,f,a);var g=a.runCode;!g&&u&&(g=u);var O=new i(a,g),v=d[f]||{},h={};d[f]={},R.forEach(function(e){a.os&&-1!==a.os.indexOf(e)?(d[f][e]=O,h[e]=!0):v[e]&&(d[f][e]=v[e],a.os&&a.os.push(e))}),Object.keys(h).forEach(function(e){v[e]&&v[e].dispose()})}}var t=e,i=t.Proxy,a=t.globalError,s=t.showError,c=t.os,u=t.callInner,d={},l={},R=["quick","dd","h5"];t.extendModule=function(e,n){if(n&&Array.isArray(n)){t[e]||r(e);for(var i=0,a=n.length;i<a;i+=1)o(e,n[i])}},t.extendApi=o}function d(e){function r(){o.runtime&&o.runtime.getQuickVersion?o.runtime.getQuickVersion({success:function(e){var n=e.version;(function(e,n){if("string"!=typeof e||"string"!=typeof n)throw new Error("version need to be string type");for(var r=e.split("."),o=n.split("."),t=Math.max(r.length,o.length),i=0;i<t;i+=1){var a=r[i]||0,s=o[i]||0;if(a-=0,s-=0,a>s)return 1;if(a<s)return-1}return 0})(o.version,n)<0&&a(i.ERROR_TYPE_VERSIONNEEDUPGRADE.code,i.ERROR_TYPE_VERSIONNEEDUPGRADE.msg)},error:function(){a(i.ERROR_TYPE_INITVERSIONERROR.code,i.ERROR_TYPE_INITVERSIONERROR.msg)}}):a(i.ERROR_TYPE_VERSIONNOTSUPPORT.code,i.ERROR_TYPE_VERSIONNOTSUPPORT.msg)}var o=e,i=o.globalError,a=o.showError,s=o.JSBridge,c=void 0,u=!1,d=!1;o.config=function(e){if(d)a(i.ERROR_TYPE_CONFIGMODIFY.code,i.ERROR_TYPE_CONFIGMODIFY.msg);else{d=!0;var s=function(){c?(n("ready!"),c()):u=!0};o.os.quick?(r(),o.auth.config(t({success:function(){s()},error:function(e){var n=JSON.stringify(e);a(i.ERROR_TYPE_CONFIGERROR.code,n)}},e||{}))):s()}},o.ready=function(e){c?a(i.ERROR_TYPE_READYMODIFY.code,i.ERROR_TYPE_READYMODIFY.msg):(c=e,u&&(n("ready!"),u=!1,c()))},s.registerHandler("handleError",function(e){a(i.ERROR_TYPE_NATIVE.code,JSON.stringify(e))})}var l={ERROR_TYPE_APIOS:{code:1001,msg:"该API无法在当前OS下运行"},ERROR_TYPE_APIMODIFY:{code:1002,msg:"不允许更改JSSDK的API"},ERROR_TYPE_MODULEMODIFY:{code:1003,msg:"不允许更改JSSDK的模块"},ERROR_TYPE_APINOTEXIST:{code:1004,msg:"调用了不存在的api"},ERROR_TYPE_PROTONOTEXIST:{code:1005,msg:"调用错误，该组件api对应的proto不存在"},ERROR_TYPE_CUSTOMEAPINOTEXIST:{code:1006,msg:"非容器下无法调用自定义组件API"},ERROR_TYPE_EVENTNOTEXIST:{code:1007,msg:"对应的event事件在该环境下不存在"},ERROR_TYPE_INITVERSIONERROR:{code:1008,msg:"初始化版本号错误，请检查容器api的实现情况"},ERROR_TYPE_READYMODIFY:{code:2001,msg:"ready回调不允许多次设置"},ERROR_TYPE_CONFIGMODIFY:{code:2002,msg:"config不允许多次调用"},ERROR_TYPE_CONFIGERROR:{code:2003,msg:"config校验错误"},ERROR_TYPE_VERSIONNOTSUPPORT:{code:2004,msg:"不支持当前容器版本，请确保容器与前端库版本匹配"},ERROR_TYPE_VERSIONNEEDUPGRADE:{code:2005,msg:"当前JSSDK库小于容器版本，请将前端库升级到最新版本"},ERROR_TYPE_NATIVE:{code:3e3,msg:"捕获到一处原生容器错误"},ERROR_TYPE_NATIVECALL:{code:3001,msg:"原生调用H5时参数不对"},ERROR_TYPE_UNKNOWN:{code:9999,msg:"未知错误"}},f=function(){},R={};return function(n){var f=n;!function(e){(function(e){this.os={};var n=e.match(/(Android);?[\s/]+([\d.]+)?/);n&&(this.os.android=!0,this.os.version=n[2],this.os.isBadAndroid=!/Chrome\/\d/.test(window.navigator.appVersion));var r=e.match(/(iPhone\sOS)\s([\d_]+)/);r&&(this.os.ios=!0,this.os.iphone=!0,this.os.version=r[2].replace(/_/g,"."));var o=e.match(/(iPad).*OS\s([\d_]+)/);o&&(this.os.ios=!0,this.os.ipad=!0,this.os.version=o[2].replace(/_/g,"."));var t=e.match(/QuickHybrid/i);t&&(this.os.quick=!0);var i=e.match(/DingTalk/i);i&&(this.os.dd=!0),i||t||(this.os.h5=!0)}).call(e,navigator.userAgent)}(f),function(e){var n=e;n.Promise=window.Promise,n.getPromise=function(){return n.Promise},n.setPromise=function(e){n.Promise=e}}(f),function(n){var r=n,o=void 0;r.showError=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"错误!";e("code:"+n+", msg:"+r),o&&o({code:n,message:r})},r.globalError=l,r.error=function(e){o=e}}(f),function(e){function n(e,n){this.api=e,this.callback=n}var r=e;n.prototype.walk=function(){var e=this,n=r.getPromise();return function(){for(var r=arguments.length,o=Array(r),t=0;t<r;t++)o[t]=arguments[t];var i=o;i[0]=i[0]||{},e.api.defaultParams&&i[0]instanceof Object&&Object.keys(e.api.defaultParams).forEach(function(n){void 0===i[0][n]&&(i[0][n]=e.api.defaultParams[n])});var a=void 0;return e.callback&&(a=e.callback),n?a&&new n(function(n,r){i=i.concat([n,r]),a.apply(e,i)}):a&&a.apply(e,i)}},n.prototype.dispose=function(){this.api=null,this.callback=null},r.Proxy=n}(f),r(f),function(e){var n=e,r=n.os,o=c(n.JSBridge);n.callInner=function(e,n,i){var a=t({},e);a.success=void 0,a.error=void 0,a.dataFilter=void 0,r.quick&&o({handlerName:this.api.namespace,data:a,proto:this.api.moduleName,success:e.success,error:e.error,dataFilter:e.dataFilter,isLongCb:this.api.isLongCb,isEvent:this.api.isEvent},n,i)}}(f),u(f),function(e){function n(e){var n=r.getPromise(),t=e||{},i=function(e,n){o({handlerName:t.name,proto:t.mudule,data:t.data||{},success:t.success,error:t.error,isLongCb:t.isLongCb,isEvent:t.isEvent},e,n)};return n&&new n(i)||i()}var r=e,o=c(r.JSBridge);r.callApi=n,r.callNativeApi=n}(f),d(f),function(e){var n=e,r={};n.innerUtil=r,r.extend=t,r.isObject=o,r.getFullPath=a,r.getFullUrlByParams=s,r.eclipseText=i,r.compatibleStringParamsToObject=function(e){var o=this,t=e;if(!r.isObject(t[0])){for(var i={},a=!!n.getPromise(),s=t.length,c=a?s-2:s,u=arguments.length,d=Array(u>1?u-1:0),l=1;l<u;l++)d[l-1]=arguments[l];for(var f=0;f<c;f+=1)void 0!==d[f]&&(i[d[f]]=t[f]);t[0]=i,a?(t[1]=t[s-2],t[2]=t[s-1]):(t[1]=void 0,t[2]=void 0)}return this.api&&this.api.defaultParams&&t[0]instanceof Object&&Object.keys(this.api.defaultParams).forEach(function(e){void 0===t[0][e]&&(t[0][e]=o.api.defaultParams[e])}),t}}(f)}(R),R.Version="1.0.0",R});